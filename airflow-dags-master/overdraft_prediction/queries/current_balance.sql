SELECT t.BANK_ACCOUNT_ID, t.CURRENT_BALANCE
FROM "LILI_ANALYTICS"."ODS"."MYSQL_CUSTOMER_BALANCE_HISTORY" t
INNER JOIN (
SELECT BANK_ACCOUNT_ID, MAX(CASE WHEN VALID_DATE <=  %(dag_run_start_date)s THEN VALID_DATE END) AS MAXDATE
FROM "LILI_ANALYTICS"."ODS"."MYSQL_CUSTOMER_BALANCE_HISTORY" tm
GROUP BY BANK_ACCOUNT_ID
) tm ON t.BANK_ACCOUNT_ID = tm.BANK_ACCOUNT_ID AND t.VALID_DATE = tm.MAXDATE